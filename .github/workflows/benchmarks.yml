# name: Benchmarks
#
# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]
#
# env:
#   CARGO_TERM_COLOR: always
#
# jobs:
#   benchmark:
#     name: Performance Regression Check
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4
#
#       - name: Setup Rust
#         uses: dtolnay/rust-toolchain@stable
#
#       - name: Cache cargo registry
#         uses: actions/cache@v4
#         with:
#           path: ~/.cargo/registry
#           key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
#
#       - name: Cache cargo index
#         uses: actions/cache@v4
#         with:
#           path: ~/.cargo/git
#           key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
#
#       - name: Cache cargo build
#         uses: actions/cache@v4
#         with:
#           path: target
#           key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
#
#       - name: Run benchmarks
#         run: cargo bench --workspace
#
#   benchmark-compare:
#     name: Compare with main
#     runs-on: ubuntu-latest
#     if: github.event_name == 'pull_request'
#     steps:
#       - name: Checkout PR branch
#         uses: actions/checkout@v4
#
#       - name: Setup Rust
#         uses: dtolnay/rust-toolchain@stable
#
#       - name: Cache cargo registry
#         uses: actions/cache@v4
#         with:
#           path: ~/.cargo/registry
#           key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
#
#       - name: Cache cargo index
#         uses: actions/cache@v4
#         with:
#           path: ~/.cargo/git
#           key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
#
#       - name: Cache cargo build
#         uses: actions/cache@v4
#         with:
#           path: target
#           key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
#
#       - name: Run benchmarks on PR
#         run: cargo bench --workspace -- --save-baseline pr
#
#       - name: Checkout main
#         run: |
#           git fetch origin main
#           git checkout origin/main
#
#       - name: Run benchmarks on main
#         run: cargo bench --workspace -- --baseline pr
#
#       - name: Check for regressions
#         run: |
#           # This will fail if any benchmark regresses by more than 10%
#           cargo bench --workspace -- --baseline pr --regressions-only 2>&1 | tee benchmark_results.txt
#           if grep -q "regressed" benchmark_results.txt; then
#             echo "::warning::Performance regression detected!"
#             cat benchmark_results.txt
#           fi
